<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>

    <script src="Scripts/knockout-3.3.0.js"></script>
    <script src="Scripts/jquery-1.10.2.js"></script>
    <script src="Scripts/moment.js"></script>
    <script src="Scripts/jquery.maskedinput.js"></script>

    <script src="KnockoutModels/LoadListViewModel.js"></script>
    <script src="KnockoutModels/InventoryViewModel.js"></script>
    <script src="KnockoutModels/DetailViewModel.js"></script>
    <script src="KnockoutModels/EventViewModel.js"></script>
    <script src="KnockoutModels/TruckListViewModel.js"></script>
    <script src="KnockoutModels/BOMViewModel.js"></script>

    <link href="Content/Site.css" rel="stylesheet" />
    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="JQueryUI/jquery-ui.css" rel="stylesheet" />
    <script src="JQueryUI/jquery-ui.js"></script>
    <link href="JQueryUI/jqte/jquery-te-1.4.0.css" rel="stylesheet" />
    <script src="JQueryUI/jqte/jquery-te-1.4.0.min.js"></script>

    <script type="text/javascript">
        $(".span1").css("width", "20px");
    </script>

</head>
<body>

    <div data-bind="with: ViewModel.oEvent">
        <h2 class="panel-title" data-bind="text: 'Event: ' + eventName(), css:{color:'blue'}"></h2>
    </div>
        <div id="myTabs" data-bind="tabs: true">
            <!--<ul class="nav nav-tabs" data-bind="tabs: true" id="myTabs">-->
            <ul>
                <li><a id="TbEvent" href="#tabs-1">Events</a></li>
                <li data-bind="visible: ViewModel.oEvent()!=null ">
                    <a id="TbDetail" href="#tabs-2">Items/Event</a>               
                </li>
                <li data-bind="visible: ViewModel.oEvent()!=null "><a id="TbTruck" href="#tabs-8">Print</a></li>
                <li><a id="TbEventDE" href="#tabs-3">addEvent</a></li>

                <li data-bind="visible: ViewModel.loadListViewModel.Load().length > 0 "><a id="TbLoadList" href="#tabs-5">LoadList</a></li>
                <li data-bind="visible: ViewModel.inventoryViewModel.Inventory().length > 0 "><a id="TbInventory" href="#tabs-6">Inventory</a></li>
                <li><a id="TbTruck" href="#tabs-7">Trucks</a></li>
                <li><a id="tbBOM" href="#tabs-9">BOM</a></li>

                <!-- <li data-bind="visible: ViewModel.EventName()!=null"><a id="TbDetailDE" href="#tabs-4">addItem</a></li>  -->
            </ul>


            <!-- Event List -->
            <div id="tabs-1" data-bind="with: eventListViewModel"></div>

            <!-- Details -->
            <div id="tabs-2" data-bind="with: ViewModel.oEvent"></div>

            <!-- Add Event -->
            <div id="tabs-3"></div>

            <!-- Inventory -->
            <div id="tabs-6" data-bind="with: inventoryViewModel"></div>

            <!-- Load List -->
            <div id="tabs-5" data-bind="with: loadListViewModel"></div>

            <!-- Truck List -->
            <div id="tabs-7" data-bind="with: truckViewModel"></div>

            <!-- Print Event -->
            <div id="tabs-8" data-bind="with: ViewModel.oEvent"></div>

            <!-- BOMs -->
            <div id="tabs-9" data-bind="with: bomViewModel"></div>

        </div>

        <script>

            var path = location.href.toLowerCase().replace("zloanebros.html", "").replace("loanebros.html", "");

            var ViewModel;

            $.get("htmEventList.html", "", function (htm) { tEvents(htm); }, "html");

            function tEvents(htm) {
                $('#tabs-1').html(htm);
                $.get("htmDetails.html", "", function (htm) { tDetails(htm); }, "html");
            }

            function tDetails(htm) {
                $('#tabs-2').html(htm);
                $.get("htmAddEvent.html", "", function (htm) { tAddEvent(htm); }, "html");
            }

            function tAddEvent(htm) {
                $('#tabs-3').html(htm);
                $.get("htmInventory.html", "", function (htm) { tInventory(htm); }, "html");
            }

            function tInventory(htm) {
                $('#tabs-6').html(htm);
                $.get("htmLoadList.html", "", function (htm) { tLoadList(htm); }, "html");
            }

            function tLoadList(htm) {
                $('#tabs-5').html(htm);
                $.get("htmTruckList.html", "", function (htm) { tTruckList(htm); }, "html");
            }

            function tTruckList(htm) {
                $('#tabs-7').html(htm);
                $.get("htmPrintOut.html", "", function (htm) { tPrintOut(htm); }, "html");
            }

            function tPrintOut(htm) {
                $('#tabs-8').html(htm);
                $.get("htmBOM.html", "", function (htm) { tBOM(htm); }, "html");
            }
            
            function tBOM(htm) {
                $('#tabs-9').html(htm);
                applyModel();
            }



            function applyModel() {

                ko.bindingHandlers.datepicker = {
                    init: function (element, valueAccessor, allBindingsAccessor) {
                        //initialize datepicker with some optional options
                        var options = allBindingsAccessor().datepickerOptions || {};
                        $(element).datepicker(options);

                        //handle the field changing
                        ko.utils.registerEventHandler(element, "change", function () {
                            var observable = valueAccessor();
                            observable($(element).datepicker("getDate"));
                        });

                        //handle disposal (if KO removes by the template binding)
                        ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                            $(element).datepicker("destroy");
                        });

                    },

                    //update the control when the view model changes
                    update: function (element, valueAccessor) {
                        var value = ko.utils.unwrapObservable(valueAccessor()),
                            current = $(element).datepicker("getDate");

                        if (value - current !== 0) {
                            $(element).datepicker("setDate", value);
                        }
                    }
                };


                ko.bindingHandlers.tabs = {
                    init: function (element, valueAccessor, allBindingsAccessor, viewModel) {
                        $(element).tabs();

                        ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                            $(element).tabs("destroy");
                        });
                    }
                };

                ko.bindingHandlers.jqEditor = {
                    init: function (element, valueAccessor, allBindingsAccessor, viewModel) {
                        $(element).jqte({
                             blur: function () {
                                //alert("The editor is blured");
                                alert($("div.jqte_editor").html());
                                $(element).val($("div.jqte_editor").html());
                                var observable = valueAccessor();
                                observable($("div.jqte_editor").html());
                            }
                        });
                    },
                    update: function (element, valueAccessor) {

                        // var value = ko.utils.unwrapObservable(valueAccessor());
                        //$(element).html(value);
                    }
                };

                /* http://jsfiddle.net/timvdh/P4xpx/
                ko.bindingHandlers.editHTML = {
                    init: function (element, valueAccessor) {
                        $(element).on('blur', function () {
                            var observable = valueAccessor();
                            observable($(this).html());
                        });
                    },
                    update: function (element, valueAccessor) {
                        var value = ko.utils.unwrapObservable(valueAccessor());
                        $(element).html(value);
                    }
                };
                */

                // create index view view model which contain two models for partial views
                ViewModel = {
                    AsOf: ko.observable()
                 , EventName: ko.observable()
                 , EventID: ko.observable()
                 , EventDate: ko.observable()
                 , oEvent: ko.observable()
                 , eventOrders: ko.observableArray([])
                 , LoadDateBegin: ko.observable()
                 , LoadDateEnd: ko.observable()
                 , LoadTruck: ko.observable()
                 , addDetailViewModel: new Detail()
                 , detailListViewModel: new DetailList()
                 , addEventViewModel: new Event()
                 , eventListViewModel: new EventList()
                 , loadListViewModel: new LoadList()
                 , inventoryViewModel: new InventoryList()
                 , truckViewModel: new TruckList()
                 , bomViewModel: new PartList()

                }

                ViewModel.getOrders = function (Event) {


                    ViewModel.EventID(Event.id());
                    ViewModel.EventName(Event.eventName());
                    ViewModel.EventDate(Event.eventDate());
                    ViewModel.oEvent(Event);
                    ViewModel.eventOrders(Event.orderList);
                    ViewModel.LoadDateBegin(moment(Event.checkOut()).format('l'));
                    ViewModel.LoadDateEnd(moment(Event.checkIn()).format('l'));
                    // ViewModel.addDetailViewModel.CheckIn(moment(Event.eventDate()).format('l'));
                    // ViewModel.addDetailViewModel.orderQty(1);
                    //ViewModel.detailListViewModel.getDetails(Event.Id());
                    ViewModel.detailListViewModel.getDetails(Event);
                    ViewModel.loadListViewModel.getEventLoad(Event);

                    $("div.jqte_editor").html(Event.comments());


                };

                ko.applyBindings(ViewModel);

                ViewModel.AsOf(new Date());

                ViewModel.EventName("Loane Brothers");

                ViewModel.eventListViewModel.getEventAsOf(ViewModel.AsOf());

               // ViewModel.bomViewModel.getBOM();

                $("#TbEvent").click();

            }

        </script>



</body>
</html>
